---
title: Redis过期key删除策略
date: 2021-05-26
categories: [Redis]
tags: [Redis]
draft: true
---

## Redis过期key的实现

redis保存了一个过期key的字典，里面的key是指向真实键的地址(所以过期字典并没有占用很大的空间)，value保存的是键的过期时间戳

每设置一个过期的key就会在过期字典里保存key以及对应的过期时间戳，判断一个key是否过期只需要在这个过期字典里面获取到key的过期时间戳然后和当前的时间戳进行比较即可

如果一个key已经过期了，如果不及时进行清理的话就会造成内存泄露，如果过期的key很多那么占用的内存也是相当的可观

所以Redis为了防止过期key造成的内存泄露问题，采用了下面两种过期key清除策略结合的方式

- **定期抽样清除**
- **惰性删除**

​        

## RDB和过期key

在生成RDB文件的时候不会将已经过期了的key保存到RDB文件中，这样可以减少RDB文件的大小

同样如果RDB恢复的时候也不会将已经过期了的key恢复到内存中去

​     

## AOF和过期key

AOF在过期key被惰性删除或则定期删除之后会追加`del`命令，在AOF重写的时候也会检查过期的key，并且不会将过期的key记录到重写的AOF日志或则重写生成的RDB文件中

​    

## 主从复制和过期key

在Redis从节点接受到主节点的RDB文件时，如果恢复RDB文件的时候恰巧key过期了则并不会将key删除，而是完完全全的恢复RDB文件，直到主节点发现key已经过期了则会发送del命令给从节点，此时从节点才会将过期key删除

​    

## 定期抽样清除

我们可以在key过期的时候设置定时器，只要key一过期就可以将其删除，这种策略的优点就是节约内存，不会造成内存浪费，但是缺点也很明显: 如果有大量的key同时过期则删除操作会占用服务器时间很久

所以有一种折中的办法就是定期删除一部分过期的key，这样即不会占用服务器太久，也能定期的删除一些过期了的key而不至于造成太严重的内存泄露问题

Redis就是采用这种策略定期的删除一部分过期了的key

​    

## 惰性清除

Redis除了采用定期抽样删除，还会采用惰性删除策略。当获取一个key发现这个key已经过期了，但是还没被删除掉，则此时就会删除这个key

通过 **定期删除+惰性清除** Redis基本可以有效的降低过期key带来的内存泄露问题了