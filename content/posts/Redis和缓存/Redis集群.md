---
title: Redis集群
date: 2021-05-26
categories: [Redis]
tags: [Redis,集群]
draft: true
---

## 主从复制

主从复制集群模式下，一个redis集群只有一台`master`节点负责写数据，其他`slave`节点只是master节点的一个副本，在slave节点上只能读而不能写

优点:

- 读写分离，读数据负载均衡，减轻master节点读数据的压力
- 数据备份，如果master节点挂了，但是还是可以读数据，如果master节点数据丢失了，则slave节点还可以起到一个数据备份的作用

缺点:

- 写数据的压力依然在master节点上，如果master节点挂了则此redis集群就失去了写数据的能力，只能读数据
- 如果master节点挂了则需要人工手动指定一个master节点来恢复集群，或则等待master节点恢复回来此集群才可用

主从复制模式可以配置成树状结构，此结构的集群依然只能由最顶部的根节点才可以写数据，其他节点都只能读数据。也就是说树状集群和星型集群没什么区别，只是将之前的 **单主复制** 转化为了 **多主复制** ，减轻了只有一个`master`的复制压力

只是说如果我根节点挂了则可以指定二级子节点为master，则其子树就可以继续读写数据

新master节点的兄弟节点则需要手动指定master，而master节点下的子树就不需要指定了

配置主从集群时，我们只需要指定每个`slave`节点的`master`节点是谁即可，一旦指定则此节点即为slave节点。而没有指定的节点则默认为master节点

```bash
#slave节点中配置master节点的地址
replicaof 192.168.249.20 6379
```

```bash
info replication #查看集群信息
role #查看自己的角色，如果是master节点则会列出自己的slave节点列表
```

在slave刚连上master的时候master会执行`BGSAVE`命令生成一个RDB文件，在执行BGSAVE的时候会将新的命令先保存在缓存区里面，master会将RDB文件发送给新连的slave节点，slave节点就可以根据RDB文件进行恢复数据了。之后master节点就会将buf里面的命令继续传输给slave节点，这样就可以达到完全一致了

完全一致之后，master每接受到一个写命令则会将这个命令发送给slave节点以此来同步master

还需要注意一个部分同步问题，即在slave服务器挂机之后再次恢复之后如何同步    

​    

## 哨兵模式

哨兵模式下，多了哨兵节点监控集群(为了保障哨兵不会挂一般需要创建哨兵集群)，如果集群中的master节点挂了则会被哨兵感知到，此时哨兵就会进行选举，从剩下的slave节点中选举一个master节点出来(这里有个选举策略算法需要知道一下)，此操作会改写节点对应的`conf`配置文件，以便于在机器重启的时候集群依然有效

sentinel模式可以自动选举出一个master节点，而不需要人工干预去手动选择，手动恢复集群需要一个个去配置每个节点的新的master，如果节点数量很多则是一个比较宏伟的工程，并且人也不可能无时无刻的盯着集群，人要休息但是机器不需要

哨兵模式下本质还是主从复制的结构，集群中还是只有一个master节点有写数据的能力，无法从根本上解决写数据的性能问题，如果写数据并发量比较大则一个master可能撑不住，会经常挂，就会经常频繁的进行选举，这也是比较耗时并且降低了集群的并发处理能力

`sentinel`一般配置为集群，当认为master节点挂了的`sentinel`节点数量达到了`quorum`配置的数量时就认为master节点挂了，则会再选举出一个新的master节点(会改写各个redis节点的config文件)，sentinel会根据一定的规则选举出新的master节点

quornum一般配置为`sentinel`集群节点数量的一半以上，少数服从多数原则。当之前挂了的`master`恢复之后会被哨兵感知到，同时恢复了的节点就只能当slave节点了

哨兵模式的缺点有如下:

- 集群规模会因为哨兵的增加而变得复杂
- 还是无法解决单master写并发的问题

​     

## Redis Cluster无主集群

在Redis3.0引入了`redis cluster`无主集群模式，这是Redis推荐的一种集群方案，此集群模式每个节点都可以进行读写

Redis将空间划分为`16384`个槽，每个节点负责一部分的槽位。一个key在多个节点中只会保留一份，如果我们往集群写数据则会根据一定的算法将这个key分配到某个节点上

如果我们往一个节点里去获取数据，这个key不在这个节点上的话则会请求这个key对应所在的节点然后返回给客户端

也就是说此集群模式下，获取一个key或则设置一个key可能需要进行两次请求。但是这种模式让集群的读写能力大大增加，每个节点都具备读写能力

如果有节点需要加入 `redis cluster`则会为其分配槽，并且将原来槽位上的key迁移到新加入的节点中

为了保障数据的安全性和稳定性，同时提升读数据的能力，我们也可以为`redis cluster`集群中的每个节点再设置`slave`节点来备份数据同时提高数据读的能力，这个思想和上面的主从复制模式一样，如果其中一个`cluster`节点挂了则会将其对应的slave节点顶替上来，如果此`cluster`节点所有的slave全挂了则此集群就不可用了

