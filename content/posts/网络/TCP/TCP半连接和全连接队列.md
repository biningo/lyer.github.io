---
title: TCP半连接和全连接队列
date: 2021-05-27
categories: [网络/TCP]
tags: [TCP]
---

## 什么是半连接和全连接队列

操作系统在`listen`开启监听时就会建立两个队列

- 半连接
- 全连接

半连接队列存放的就是一些还没建立TCP连接，并且还在三次握手过程中的客户端连接

全连接队列存放的就是一些已经完全建立TCP连接但是还没被应用层取走的连接，每次应用层调用`accept`时就会从全连接队列里取一个连接去处理，但是如果队列中没有连接就会阻塞

​    

## 半连接队列

当服务器端在`LISTEN`状态时能接受其他客户端的TCP建立连接请求，当服务器收到客户端发来的`SYN`包时就会回复`ACK+SYN`，此时服务器就进入了 `SYN_RECV`的状态，这个时候服务器就会将这个连接存放到半连接队列中，并且等待客户端发来应答的ACK

如果在指定时间内客户端没有发第三次握手，则服务器会进行重试直到超过一定次数则会将此连接从半连接队列里面删除

```bash
#SYN+ACK重试次数 默认为5
/proc/sys/net/ipv4/tcp_synack_retries
```

​    

如果客户端发来了第三次握手ACK，则会将此连接放入全连接队列等待用户应用去队列里面取

如果半连接队列满了的话，则服务器不会继续接受客户端的连接请求，当其他客户端想要建立TCP连接发送`SYN`时，服务器就会发送`RST`报文告诉客户端 "连接失败"或则是直接丢弃

​    

## 半连接队列大小

半连接队列大小收到下面几个因素影响

- 用户层 listen 传入的`backlog` （用户传入的全连接队列大小）
- 系统变量 `net.ipv4.tcp_max_syn_backlog`，默认值为 128
- 系统变量 `net.core.somaxconn`，默认值为 128 （Linux配置的全连接队列大小）

```c
int listen(int sockfd, int backlog); //第二个参数
```

```bash
/proc/sys/net/ipv4/tcp_max_syn_backlog #1024
/proc/sys/net/core/somaxconn #4096
```

如果我们想要增加半连接队列的大小，我们就需要同时增加上面三个值，而单单的增加其中的几个则可能无法增加半连接队列的大小

​    

## 全连接队列

当服务器收到客户端发来的第三次握手的时候，服务器就会将这个连接从半连接队里里面转移到全连接队里面并等待应用去全连接队列里取连接进行处理，应用一旦取走该连接就不会保存在队列里了

> 全连接队列只是用来保存已经建立TCP连接但是还没被用户取走待处理的连接

如果全连接队列满了的话服务器会使用下面两种策略，用户可以在一下文件中配置

```bash
/proc/sys/net/ipv4/tcp_abort_on_overflow
```

- `0` **全连接队列满了则server会丢弃ACK，当作没收到**

    即使收到了客户端发来的第三次握手ACK也会丢弃当做没收到，则此半连接就无法进入全连接队里，同时server端也会在超时的时候继续发送`SYN+ACK`，当重试超过指定次数之后全连接队列还是满的则会因为将此半连接删除

- `1` **全连接队列满了则会发送RST包告诉客户端废除这个连接请求**

一般配置为0可以有效的增加服务器的并发能力，可能全连接队列只是短暂的满了，之后会被快速取走，则配置为0之后，在后面重试的ACK中还是可以建立连接的

​    

## 全连接队列大小

全连接大小由操作系统配置`somaxconn`和用户应用配置的`backlog`两个值确定的

```bash
min(somaxconn, backlog)
```

```c
int listen(int sockfd, int backlog) //用户决定
```

```bash
/proc/sys/net/core/somaxconn #4096 操作系统参数
```

我们如果要增加全连接大小，则需要考虑操作系统的配置以及应用程序传入的配置，取他们之间最小的一个，也就是说即使应用程序传入的`backlog`再大，如果`somaxconn`很小的话则依然无法增加全连接队列的大小

全连接队列的大小决定了服务器能同时接受多少了TCP连接请求

​    

## 相关的Linux命令

```bash
# Socket Statistics
# -l 表示LISTEN状态的TCP
# -n 不解析服务名称直接显示IP
# -t 只显示TCP
# Recv-Q　全连接队列的里连接的个数
# Send-Q  全连接队列的容量
ss -ntl 
```

​    

## SYN攻击

SYN攻击就是和半连接队列有关了，黑客只需要伪造一个不存在的IP向服务器发送大量的SYN连接请求，服务器就永远无法得到第3次握手，那么就会有大量的半连接状态的TCP积压在半连接队列中，而其他真正想要发起连接的TCP请求却永远都得不到连接

> 如何抵御SYN洪泛攻击?

- 增⼤半连接队列（没啥用）
- 开启 `tcp_syncookies` 功能
- 减少 `SYN+ACK` 重传次数

​     

## 参考

[再聊 TCP backlog](https://juejin.cn/post/6844904071367753736#heading-0)

[再聊 TCP backlog](https://juejin.cn/post/6844904071367753736#heading-1)

[TCP 半连接队列和全连接队列满了会发生什么？又该如何应对？](https://www.cnblogs.com/xiaolincoding/p/12995358.html)